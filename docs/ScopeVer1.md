# 3. スコープ定義

- **なぜ必要か**・**何を書くか**・**どのように書くか**
    - **なぜ必要か**：開発対象の機能範囲を明確にし、時間やコストのオーバーを防ぐため。
    - **何を書くか**：
        - **In-Scope**：必ず作る機能（例：投稿、地図表示など）
        - **Out-Of-Scope**：対象外の機能（例：決済、動画配信）
    - **どのように書くか**：表形式で機能をリスト化し、各項目に簡単な説明を付ける。

これが **Version 1 の機能 & フォルダ構成** の確定版です。

## Version 1 機能リスト　― 最終形態との差分早見表

| # | 領域 | Version 1 実装 | 変更点メモ |
| --- | --- | --- | --- |
| **1** | **ユーザー管理** | **✅ メール＋PW / Apple / Google OAuth**✅ セッション永続化 (MMKV)✅ プロフィール編集（表示名・アイコン） | ❌ 匿名ブラウズ・OTP/MagicLink・自己紹介・2FA は Later |
| **2** | **地図 & 位置情報** | **✅ 現在地マップ表示**✅ 距離フィルタ（スライダー）✅ 再センタリング | ❌ クラスタリング・バックグラウンド測位・オフライン・AR は Later |
| **3** | **レイヤー** | **✅ 運営プリセット5種の切替のみ** | ❌ CRUD・パスワード付き・メンバー権限は Later |
| **4** | **SoundPin 投稿 & 閲覧** | **✅ 1–180 s 録音アップ**✅ タイトル60/本文100✅ 公開/非公開・編集・論削✅ 位置誤差±20 m | ❌ タグ・テンプレ再投稿・個別パスワード・全文検索は Later |
| **5** | **再生 & ログ** | **✅ Progressive再生**✅ バックグラウンド継続✅ play_events 記録 | ❌ HLS/ABR・速度変更・連続再生は Later |
| **6** | **いいね・コメント・フォロー** | **✅ いいね**✅ 1階層コメント (soft-delete)✅ 片方向フォロー | ❌ メンション通知は Later |
| **7** | **通知センター** | **❌（V1では未実装）** | Later で Push & バッジ |
| **8** | **DM** | **✅ 1:1 テキスト + ≤30 s 音声** | ❌ グループ・検索・ピン留めは Later |
| **9** | **検索** | **❌（V1未実装）** | 全文／タグ検索は Later |
| **10** | MyPin・近接 | ❌ | 丸ごと Later |
| **11** | 課金 | ❌ | Free のみ／Stripe Later |
| **12–26** | 通報・レコメンド・オフライン・QA… | ❌ or Later | V1 では省略（表の通り） |

> ✅ = 実装　❌ = 未実装　Later = 2 系以降の候補
> 
> 
> **V1 の中心価値** = *“録音ピンを地図で共有し、他ユーザーとリアクション＆DM できる”* に絞りました。
> 

---

## Version 1 `features/` フォルダ構成（差分マーク付き）

```
features/
├─ auth/              🟢  認証 (メール+OAuth)・JWT
├─ account/           🟢  プロフィール編集
├─ map/               🟢  Map表示＋距離フィルタ
│   ├─ ui/MapScreen.tsx
│   └─ model/mapStore.ts
├─ layers/            🟢  プリセット5レイヤー取得のみ
├─ audioPin/          🟢  録音→投稿／編集／削除
├─ playback/          🟢  Progressive再生＋play_events
├─ social/            🟢  Like／Follow
├─ comments/          🟢  1階層コメント
├─ messaging/         🟢  1:1 DM (Realtime WS)
├─ security/          🟢  RLS helpers
├─ shared/            🟢  ui-kit／hooks／types
├─ notifications/     🔒  *Later*（Push & 未読バッジ）
├─ search/            🔒  *Later*（全文検索）
├─ proximity/         🔒  MyPin & 近接
├─ billing/           🔒  サブスク
├─ moderation/        🔒  通報・AIフィルタ
├─ recommendation/    🔒  レコメンド
├─ feature_flags/     🔒  フラグ管理
└─ ...                （その他フォルダは将来追加余地）

```

- **🟢 = V1 に含む**／**🔒 = 今回はスケルトンのみ**
- 後方互換を保つため、Later フォルダは名前予約だけして **依存ゼロ** のダミー index.ts を置く方針です。


## Version final 最終形態フォルダ構成(アプリが最終的に目指す形で Version 1 では完成しない)

- **auth**
    - 担当する機能
        - ユーザー登録・ログイン
        - 認証フロー（メール／OAuth／OTP）
        - セッション管理
    - スコープ詳細
        - サインアップ / ログイン
            - メール＋パスワード、Apple・Google OAuth、メール OTP／Magic Link による認証方式を提供
            - 匿名ブラウズモード：未認証状態でも閲覧のみ可能
        - セッション永続化
            - MMKV に JWT を保存し、起動時に自動再認証（リフレッシュトークン運用）
        - アカウント保護
            - パスワード変更・退会（CASCADE で関連データ削除）
            - 2FA（TOTP／SMS）は将来フラグで有効化
- account
    - 担当する機能
        - プロフィール編集
        - 公開プロフィール URL 生成
        - ユーザーブロック／ミュート
    - スコープ詳細
        - プロフィール編集
            - 表示名・アイコン・自己紹介を更新（`updated_at` トリガ）
        - 公開プロフィール
            - 固定 URL 生成＋シェア可能
        - ブロック / ミュート
            - `blocked_users` に登録し、ピン・コメント・DM を非表示
- **map**
    - 担当する機能
        - 現在地マップ表示
        - クラスタリング・距離フィルタ
        - オフラインタイルキャッシュ
    - スコープ詳細
        - マップ表示
            - Mapbox / Google Maps SDK で現在地中心に表示
            - 表示範囲が変化したタイミングで `ST_DWithin` を用いたピン再取得
        - ピンクラスタリング
            - GeoJSON + Supercluster でクラスタリング描画
        - 測位 & キャッシュ
            - 省電力バックグラウンド測位・オフラインタイルパック
- **layers**
    - 担当する機能
        - レイヤー（コミュニティ／カテゴリ）管理
        - メンバーシップ & ガイドライン
    - スコープ詳細
        - レイヤー CRUD
            - 公開／非公開（パスワード保護）、名称・説明・カバー画像
            - 作成上限：Free = 3、Pro = Unlimited
        - メンバーシップ
            - join / leave／role = member・admin、通知購読・お気に入り
        - ガイドライン & モデレーション
            - ガイドライン 200 字保存・違反通報処理
- **audioPin**
    - 担当する機能
        - SoundPin 投稿・編集・削除
        - 全文検索 & テンプレート再投稿
    - スコープ詳細
        - 投稿フロー
            - 録音プレビュー → 投稿確定時に Supabase Storage へアップロード（1–180 s）
            - タイトル 60 字・本文 100 字・タグ付与
        - 編集 & 削除
            - 公開 / 非公開（パスワード保護）切替・論理削除 (`deleted_at`)
        - 位置誤差マージン
            - ±20 m を同一点扱いでグルーピング
        - 再投稿テンプレート
            - 過去ピンから複製して時刻・位置のみ更新
        - 検索
            - `to_tsvector` + `pg_trgm` による全文検索
- **playback**
    - 担当する機能
        - 音声再生 & ストリーミング
        - 再生ログ & キャッシュ
    - スコープ詳細
        - 再生エンジン
            - HLS / Progressive、Adaptive Bitrate 自動切替
            - 再生速度 0.5–2.0×、バックグラウンド／ロック画面制御
        - 再生制御ロジック
            - 再生開始後 10 % で自動停止（ユーザ設定可）
            - 距離順／時間順の連続再生キュー
        - キャッシュ
            - IndexedDB / MMKV へ音声をプリフェッチ
        - 再生ログ
            - `play_events` に user/pin/lat/lng/device を記録
- **search**
    - 担当する機能
        - タグフィルタ & 高度検索
        - 検索履歴 & サジェスト
    - スコープ詳細
        - タグ検索
            - `pin_tags` 参照で複数タグ AND／OR／除外検索
        - フリーワード検索
            - 全文検索・除外キーワード対応
        - 補助機能
            - 検索履歴保存、サジェスト、タグクラウド生成
- **social**
    - 担当する機能
        - いいね
        - フォロー・メンション
    - スコープ詳細
        - いいね
            - ピン & コメントに対してトグル式
        - フォロー
            - 片方向フォロー、フォロー／フォロワー一覧
        - メンション
            - `@username` 検出 → 通知センターへ
- **notifications**
    - 担当する機能
        - 通知センター UI
        - Push 配信 & 既読管理
    - スコープ詳細
        - 通知リスト
            - 未読バッジ (`is_read = FALSE`)、種別 like/comment/follow/DM/admin
        - Push 配信
            - Expo Push → APNs / FCM 経由
            - イベント別 ON/OFF、サイレント時間帯設定
- **messaging**
    - 担当する機能
        - 1:1 / グループ DM
        - ピンコメント管理
        - 既読・検索・ピン留め
    - スコープ詳細
        - スレッド管理 (`dm_threads`)
            - 参加ユーザー & last_read_at を保持
        - メッセージ送信
            - テキスト・メディア・音声（≤ 30 s）
        - コメント管理
            - ピンへのコメント作成・編集・削除（最大 300 字、soft‑delete）
        - 補助機能
            - スレッド検索、重要スレッドをピン留め
- **proximity**
    - 担当する機能
        - MyPin 登録
        - 近接検知 & すれ違い履歴
    - スコープ詳細
        - MyPin
            - 最大 5 レイヤーに音声（≤ 60 s）を設定
        - 近接検知
            - Edge + Redis GEO で半径内ユーザーを検出
        - すれ違い履歴
            - タイムライン表示・プライバシー距離閾値 (5 m)
- **billing**
    - 担当する機能
        - サブスクリプション課金
        - プラン上限解除
    - スコープ詳細
        - プラン管理
            - Free / Pro (480 円/月)・Stripe Checkout
        - 機能制御
            - レイヤー作成数・ピン公開上限をプランで切替
        - 将来拡張
            - ファミリープラン・学生割引を Feature Flag で制御
- **moderation**
    - 担当する機能
        - 通報 & モデレーション
        - AI 文字起こし & NG ワード
    - スコープ詳細
        - 通報フロー
            - ピン／コメント／レイヤーを `reports` に記録
        - AI モデレーション
            - Whisper で文字起こし → NG ワード検出
            - 波形ハッシュで重複音声をフラグ
        - 管理権限
            - 管理者・レイヤー管理者による削除／BAN
- **recommendation**
    - 担当する機能
        - 行動分析 & レコメンド
        - A/B テスト管理
    - スコープ詳細
        - 行動ログ
            - 再生回数・いいね等を BigQuery へ送信
        - レコメンド API
            - 距離 × 履歴 × フォロー × タグでスコアリング
        - 実験管理
            - A/B テスト指標を収集しフィード最適化
- **security**
    - 担当する機能
        - アプリ全体のセキュリティ & プライバシー
    - スコープ詳細
        - アクセス制御
            - Supabase RLS で本人データのみ許可
        - 暗号化
            - HTTPS/TLS1.3、AES‑256 at rest (`pgcrypto`)
        - レートリミット
            - Edge Function で IP／ユーザー単位制限
        - 法令順守
            - GDPR / 個人情報保護法の削除・データ移行 API
- **sharing**
    - 担当する機能
        - 共有 & エクスポート
    - スコープ詳細
        - 動的リンク & QR 共有
            - Firebase Dynamic Links / Branch.io
        - エクスポート
            - 投稿者が自身の音声ファイルを再ダウンロード
- **onboarding**
    - 担当する機能
        - 初回チュートリアル
        - パーミッションガイド
    - スコープ詳細
        - チュートリアルスライド
            - スキップ可、重要 UI をコーチマークで説明
        - パーミッション要求
            - 位置情報 → マイク → 通知の順で段階取得
- **accessibility**
    - 担当する機能
        - アクセシビリティ対応
        - 多言語 i18n
    - スコープ詳細
        - アクセシビリティ
            - スクリーンリーダーラベル・ダイナミックフォントサイズ
        - i18n
            - 日本語 / 英語 JSON 辞書、RTL 対応の余地
- **feature_flags**
    - 担当する機能
        - フィーチャーフラグ管理
        - A/B テスト切替
    - スコープ詳細
        - フラグ管理
            - ConfigCat / LaunchDarkly SDK ラッパー
        - 機能段階展開
            - MyPin は v0.4 以降で ON、近接再生やレコメンドロジックを段階配信

## 最終形態機能一覧

```python
### 1. ユーザー管理 & 認証

* サインアップ / ログイン

  * メール＋パスワード、Apple・Google OAuth
  * メール OTP / Magic Link
  * 匿名ブラウズモード（閲覧のみ可）
* セッション永続化

  * MMKV に JWT 保存 → 起動時に自動再認証
* プロフィール編集

  * 表示名・アイコン・自己紹介（updated_at トリガ）
  * 公開プロフィール URL 生成
* アカウント保護

  * パスワード変更、退会（CASCADE で関連削除）
  * 2FA（TOTP／SMS）は将来オプション
* ユーザーブロック / ミュート（章 19 参照）

### 2. 地図 & 位置情報

* 現在地中心マップ表示（Mapbox / Google Maps SDK）
* ズーム連動ロード（ST_DWithin + sound_pins.geom）
* 距離フィルター（例: 半径 10 m 以内ピンのみタップ可）
* 再センタリング・コンパスモード
* ピンクラスタリング（GeoJSON + Supercluster）
* バックグラウンド測位（省電力）
* オフラインタイルキャッシュ（Mapbox Offline Packs）
* AR 表示（カメラ上にピンをレンダリング、将来対応）

### 3. レイヤー（コミュニティ / カテゴリ）

* 公開 / 非公開 / パスワード付き

  * layers.is_public, require_pass, pass_hash
* 名称・説明・カバー画像、カテゴリータグ複数選択
* レイヤーメンバーシップ（join / leave / role = member・admin）
* レイヤーお気に入り登録、通知購読
* 作成上限: Free = 3、Pro = Unlimited
* レイヤーガイドライン（200 字）と違反モデレーション

### 4. SoundPin 投稿 & 閲覧

* 録音プレビュー → 投稿確定時に Storage アップロード (1–180 s)
* タイトル 60 字、本文 100 字、タグ付与
* ローカル / リモート (pin_type)
* 公開 / 非公開、後から編集、論理削除 (deleted_at)
* 位置誤差マージン設定（±20 m 同一点扱い）
* 再投稿テンプレート（過去ピン複製）
* 全文検索（to\_tsvector + pg\_trgm）

### 5. 再生 & ストリーミング

* HLS / Progressive、Adaptive Bitrate 切替
* クライアント側 10 % 再生で自動停止（設定可）
* 再生ログ: play_events (user/pin/lat/lng/device)
* 距離順 / 時間順 連続再生キュー
* バックグラウンド / ロック画面コントロール
* 再生スピード 0.5 – 2.0 ×

### 6. タグ & 高度検索

* タグフィルター（pin_tags → pin）
* フリーワード検索（AND / OR / 除外）
* 履歴 & サジェスト（search_logs）
* タグクラウド / 人気タグランキング

### 7. いいね・コメント・フォロー

* 投稿 / コメントへのいいねトグル
* コメント (≤ 300 字) + soft-delete
* 片方向フォロー、フォロー / フォロワー一覧
* メンション (@username) → 通知
* Supabase Realtime でライブ更新

### 8. 通知センター

* 未読バッジ (notifications.is_read = FALSE)
* 種別: like / comment / follow / DM / admin
* プッシュ通知 (Expo Push + APNs/FCM)
* 通知設定: イベント別トグル、サイレント時間帯

### 9. ダイレクトメッセージ（DM）

* 1:1 / グループスレッド (dm_threads)
* テキスト・メディア送信 (Supabase Storage)
* 既読管理 (last_read_at)
* スレッド検索、ピン留め
* 音声 DM（30 s 以内録音送信）

### 10. MyPin & すれ違い機能

* MyPin 登録（≤ 60 s）× 最大 5 レイヤー
* Edge + Redis GEO で近接検知
* すれ違い履歴タイムライン
* プライバシー距離閾値変更（50 / 100 / 200 m）

### 11. サブスクリプション / 課金

* プラン一覧: Free / Pro (480 円/月)
* Stripe Checkout → user_subscriptions
* レイヤー作成数 / ピン公開上限解除
* ファミリープラン・学生割引は将来オプション

### 12. 通報 & モデレーション

* ピン / コメント / レイヤー通報 (reports)
* 管理者ダッシュボード（supabase-studio 拡張）
* レイヤー管理者の削除・BAN 権限
* AI 文字起こし＋NG ワード自動フラグ

### 13. 行動分析 & レコメンド

* 管理ダッシュボード: 再生回数、DAU/WAU など K-Factor 指標
* 個人フィード最適化（距離 × 履歴 × フォロー × タグ）
* A/B テスト基盤
* レコメンド API を別 Cloud Run マイクロサービス化

### 14. セキュリティ & プライバシー

* RLS で本人データのみアクセス
* GDPR / 個人情報保護法: 削除 & データ移行
* HTTPS / TLS1.3、pgcrypto AES-256
* Edge Function レートリミット
* コンテンツハッシュで重複投稿抑制

### 15. オフライン対応 & パフォーマンス

* 音声キャッシュ (IndexedDB / MMKV)
* マップタイル & ピンプリフェッチ
* App Clip / Instant App（将来）
* 低電力モード時の位置更新バックオフ

### 16. アプリ運用 & 管理

* リリースフロー: GitHub Actions → EAS Build / Fastlane
* 障害検知: Sentry・LogRocket
* 利用規約 / プライバシーポリシー WebView
* SBOM (CycloneDX) 自動生成
* 運用 Runbook を Notion に集約

### 17. オンボーディング & パーミッション管理

* 初回チュートリアルスライド、スキップ可
* 位置情報・マイク・通知の順次リクエスト
* コーチマークで主要 UI をガイド

### 18. アクセシビリティ & 多言語対応

* スクリーンリーダー互換ラベル
* ダイナミックフォントサイズ対応
* 日本語 / 英語の i18n JSON 辞書

### 19. ユーザー保護 & ブロック機能

* ユーザーブロック / ミュート (blocked_users)
* ブロック相手のピン・コメント・DM 非表示
* キーワードミュート機能は将来
* 年齢レーティング 12+ と COPPA ガード

### 20. コンテンツガイドライン & 自動モデレーション

* NG ワードフィルタ（Whisper で音声→文字起こし）
* 波形ハッシュによる重複・類似検知
* コミュニティガイドラインをアプリ内掲示

### 21. 共有 & エクスポート拡張

* 動的リンク生成 (Firebase Dynamic Links / Branch.io)
* QR コードでレイヤー / ピン共有
* 投稿者による音声ファイル再ダウンロード

### 22. ロギング・監査 & 分析基盤

* クラッシュログ: Sentry
* パフォーマンス: Firebase Performance Monitoring
* DB 監査: Supabase Audit Extension
* BigQuery 連携 → Looker Studio 可視化

### 23. バックアップ & ディザスタリカバリ

* Supabase Point-in-Time Recovery (最大 7 日)
* 音声ファイルを 1 日 1 回 S3 ミラー
* DR 手順: 主要リージョン障害時に 60 分以内復旧

### 24. QA / テスト & DevOps

* ユニットテスト: Vitest / Jest カバレッジ 80 %以上
* E2E テスト: Detox + Firebase Test Lab
* Lint / Format: ESLint, TypeScript strict, Prettier, Husky
* CI/CD: PR で CI、main マージで自動ビルド & Store 配布
* 段階リリース: internal → beta → production

### 25. 技術・法務コンプライアンス

* GDPR / 個人情報保護法対応（削除 30 日以内）
* 暗号化ポリシー: HTTPS 100 %、AES-256 at rest
* OSS ライセンス管理: CycloneDX SBOM
* WCAG 2.2 AA 準拠（コントラスト比 4.5:1 など）

### 26. フィーチャーフラグ & ロードマップ

* MyPin 機能は v0.4 以降でフィーチャーフラグ ON
* A/B テスト対象: 近接再生、レコメンドロジック、SNS シェア UI
* Feature flag 管理は ConfigCat / LaunchDarkly を想定

```