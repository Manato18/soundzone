# SoundZone - 変更履歴

## [2.1.0] - 2025-01-04 - 🎨 レイヤーシステム実装 & モーダルUI大幅改善

### 🎨 レイヤーシステム実装
- **5つの固定レイヤー**を実装
  - 🏛️ 観光地（tourism）- 赤色
  - 🍽️ グルメ（gourmet）- 緑色  
  - 📚 文化（culture）- 青色
  - 🌿 自然（nature）- 緑色
  - 🎪 イベント（event）- 黄色
- **レイヤー選択UI**（右上角）
  - 複数選択可能
  - 視覚的フィードバック付き
  - リアルタイムピンフィルタリング
- **新しいコンポーネント・フック**
  - `LayerSelector.tsx` - レイヤー選択UI
  - `useLayerSelection.ts` - レイヤー選択状態管理
  - `useAudioPinFiltering.ts` - レイヤーベースピンフィルタリング
  - `LayersScreen.tsx` - 詳細レイヤー管理画面
- **AudioPinエンティティ拡張**
  - `layerIds: string[]` フィールド追加
  - 複数レイヤー所属対応

### 🎵 AudioPlayerModal大幅改善
- **3段階ボトムシート**実装
  - COLLAPSED（半画面表示）
  - EXPANDED（ほぼ全画面表示）
  - CLOSED（完全非表示）
- **高度なジェスチャー制御**
  - PanResponderによる上下スワイプ検出
  - 速度・距離に基づく状態遷移
  - スムーズなSpringアニメーション
- **レイアウト最適化**
  - プレイヤー情報部分を固定
  - 説明テキスト部分のみスクロール可能
  - 灰色背景でテキストエリアを視覚的に分離
- **新機能追加**
  - 投稿時間表示（相対時間：「2時間前」など）
  - レイヤー情報チップ表示（カラー付きアイコン）
  - タッチエリア最適化（ハンドルバー + プレイヤー情報エリア）

### 🕐 時間表示機能
- **相対時間ユーティリティ**実装
  - `getRelativeTime()` - 相対時間表示
  - `formatDuration()` - 再生時間フォーマット
- **AudioPinエンティティ拡張**
  - `createdAt?: Date` フィールド追加（オプショナル）
- **サンプルデータ更新**
  - 投稿時間情報を追加（4分前、2時間前、1日前）

### 🐛 バグ修正・パフォーマンス改善
- **React 18 ストリクトモード完全対応**
  - useInsertionEffect エラー完全修正
  - マウント状態追跡（`isMountedRef`）実装
  - 安全な状態更新関数（`safeSetState`）実装
  - `requestAnimationFrame`による状態更新遅延
  - アニメーション完了後の安全なコールバック処理
  - panResponder内での状態遷移安全化
  - メモリリーク防止・クリーンアップ処理強化
- **useLayoutEffect活用**
  - レンダリング前の同期実行保証
  - currentStateRef同期の最適化
- **TypeScript エラー解決**
  - 型定義の整合性確保
  - インポート問題の修正
- **panResponder最適化**
  - ScrollViewとの競合回避
  - ジェスチャー認識精度向上
  - イベントループ制御による安定化 