# SoundZone - 変更履歴

## 2025-01-26

### Location機能の状態管理一元化（Phase 3）

#### 実装内容
- **LocationProviderの改善**
  - Zustandストアから実際の状態を取得してContext値として提供
  - AppState監視によるフォアグラウンド復帰時の位置再取得機能を追加

- **パフォーマンス最適化**
  - `useLocationUIState`にshallow比較を実装し、不要な再レンダリングを削減
  - heading更新に250msのスロットリングを実装し、過剰な更新を抑制

- **エラーハンドリングの改善**
  - `locationStateManager`からUIアラートを分離
  - エラーコールバック機構を実装し、Presentation層でのエラー表示を実現
  - UIとビジネスロジックの責務を明確に分離

#### 技術的詳細
- StateManagement.mdの設計原則に完全準拠
- Infrastructure層（locationStateManager）からUI関連処理を除去
- Presentation層（LocationProvider）でエラー時のアラート表示を管理
- stableLocationの10m閾値を維持し、地図表示の安定性を確保

### 位置情報権限変更時の動作改善

#### 修正内容
- **AppState監視の強化**
  - フォアグラウンド復帰時に位置情報権限を再チェックする機能を追加
  - 設定画面から戻った際の権限状態変化に適切に対応

- **権限状態変化への対応**
  - OFF→ON: エラーメッセージをクリアし、位置情報サービスを自動的に初期化
  - ON→OFF: 位置情報サービスを停止し、適切なエラーメッセージを表示

- **UIの改善**
  - エラーメッセージの表示位置を現在位置ボタンと同じ高さに調整
  - エラーメッセージの幅を狭めて、現在位置ボタンと重ならないように配置

#### 解決した問題
- 位置情報をOFFからONに変更しても、エラーメッセージが消えない問題を修正
- 位置情報をONからOFFに変更した際の不適切なエラーメッセージを改善

