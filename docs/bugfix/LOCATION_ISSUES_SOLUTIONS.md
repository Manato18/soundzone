
# 位置情報機能の問題と解決策

## 概要
このドキュメントは、SoundZoneアプリの位置情報機能（`@src/features/location/`）で発見された問題とその解決策をまとめたものです。

## 最終実装計画（2025-07-26 最終決定版）

### 実装方針
- **ネットワーク関連は考慮しない**（位置情報機能のみにフォーカス）
- **位置情報が取得できない時は画面に表示しない**
- **権限処理は既に実装済みのため、追加実装は不要**

## 実装タスク一覧

### タスク1: 録音画面に位置情報表示（最優先）
**実装内容**:
1. RecordingScreen.tsxにuseLocationContextを追加
2. 緯度経度のリアルタイム表示コンポーネントを実装
3. 位置情報が取得できない時は何も表示しない

**実装ファイル**:
- `/src/features/recording/presentation/RecordingScreen.tsx`

### タスク2: 位置情報バリデーション関数（高優先）
**実装内容**:
1. 共通のバリデーション関数を作成
2. 座標値の有効性チェック（0,0の除外、範囲チェック）

**実装ファイル**:
- `/src/features/location/utils/validation.ts`（新規作成）

### タスク3: 位置情報取得のシンプルなリトライ（中優先）
**実装内容**:
1. GPS信号が弱い時の単純な再試行（最大3回）
2. ネットワークは考慮しない、GPSのみ

**実装ファイル**:
- `/src/features/location/infrastructure/services/locationStateManager.ts`

## 実装詳細計画

### Step 1: 録音画面の実装準備
1. 現在のRecordingScreen.tsxの状態を確認
2. useLocationContextのインポートと使用
3. UIコンポーネントの設計

### Step 2: 位置情報表示コンポーネントの実装
1. 緯度経度を表示するシンプルなTextコンポーネント
2. リアルタイム更新（currentLocationを監視）
3. nullチェックによる条件付き表示

### Step 3: バリデーション関数の実装
1. isValidCoordinates関数の作成
2. isValidLocation関数の作成
3. 既存コードへの適用

### Step 4: リトライメカニズムの実装
1. getCurrentLocationメソッドにリトライロジック追加
2. 単純なfor文による再試行（複雑にしない）
3. エラーハンドリングの維持

## 実装優先順位（ユーザー要望反映版）

### 1. **完了済み** ✅
- 状態の不整合問題の解決（Single Source of Truth）
- エラーハンドリングの改善（権限管理、エラーコールバック）
- パフォーマンス最適化（heading更新のスロットリング、shallow比較）
- 同期問題の解決（LocationProvider、初期化フロー）
- メモリリークの修正（refクリア実装済み）
- 地図の自動追従機能（実装済み、確認のみ必要）

## まとめ

位置情報機能の主要な問題は2025-07-26時点でほぼ解決されています。

**実装完了した内容**：
1. **タスク1**: 録音画面への緯度経度表示 ✅
2. **タスク2**: 位置情報バリデーション関数の作成 ✅
3. **タスク3**: シンプルなGPSリトライ機能 ✅
4. **追加実装**: 地図追従のスムーズ化（バランス重視設定） ✅

**スムーズ化の詳細**：
- headingThrottleInterval: 250ms → 100ms
- locationUpdateInterval: 2秒 → 1秒
- distanceFilter: 5m → 2m
- stableLocationThreshold: 10m → 3m
- 地図アニメーション: 1秒 → 0.5秒

これにより、カクカクした動きが改善され、より自然な地図追従を実現