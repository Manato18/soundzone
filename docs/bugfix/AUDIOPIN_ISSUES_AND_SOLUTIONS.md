# AudioPin機能の問題点と解決策

## 概要
AudioPin機能の現在の実装には、メモリリーク、状態管理の不整合、UXの問題など、複数の重大な問題が存在します。本ドキュメントでは、これらの問題を詳細に分析し、具体的な解決策を提案します。

## フェーズ分類
### Phase 1 (即座の修正 - 緊急度高)
- **1. 音声再生のメモリリーク問題**: モーダルを閉じても音声が再生され続ける重大な問題
  - AudioPlayerModalのクリーンアップ処理追加
  - closeModal関数での音声停止実装
  - バックグラウンド時の音声一時停止

### Phase 2 (中期改善 - 安定性向上)
- **2. レイヤー切替時のピン消失問題**: UXに影響する表示の問題
  - クエリキー最適化
  - 楽観的更新の実装
- **3. 状態管理の不整合**: 音声とUIの同期問題
  - AudioServiceシングルトンの実装
  - Zustandストアへの音声状態統合

### Phase 3 (長期改善 - アーキテクチャ最適化)
- **4. リソース管理の欠如**: 複数操作時の制御問題
  - リクエストのデバウンスとキャンセル
  - リソースプール管理システムの実装
  - 完全なエラーハンドリング

## 1. 音声再生のメモリリーク問題 【Phase 1】

### 問題の詳細
- **場所**: `components/AudioPlayerModal.tsx`
- **症状**: 
  - モーダルを閉じても音声が再生され続ける
  - TrackPlayerインスタンスが解放されない
  - アプリのメモリ使用量が増加し続ける
  - バックグラウンドでも音声が再生される

## 2. レイヤー切替時のピン消失問題 【Phase 2】

### 問題の詳細
- **場所**: `src/features/audioPin/presentation/hooks/read/useAudioPinsQuery.ts`
- **症状**:
  - レイヤーを選択/解除時にピンが一瞬消える
  - ユーザー体験が悪い（ちらつき）
  - 不要なAPIリクエストが発生

## 3. 状態管理の不整合 【Phase 2】

### 問題の詳細
- **症状**:
  - 音声再生状態がZustandストアとTrackPlayerで分離
  - `playingPinId`の更新とTrackPlayerの状態が同期しない
  - モーダルの開閉と音声再生が独立して動作

## 4. リソース管理の欠如 【Phase 3】

### 問題の詳細
- **症状**:
  - 複数ピンの高速タップで音声が重複再生
  - ネットワークリクエストのキャンセル処理なし
  - メモリリークの可能性

## 5. 実装状況

### Phase 1 実装完了 (2025-07-25)

#### 実装内容
1. **AudioPlayerModalのクリーンアップ処理追加** ✅
   - コンポーネントアンマウント時に`TrackPlayer.stop()`と`reset()`を実行
   - Zustandストアの`stopPlayback()`も呼び出して状態を同期

2. **closeModal関数での音声停止実装** ✅
   - モーダルクローズ時に音声を確実に停止
   - エラーハンドリングを追加
   - Zustandストアとの状態同期

3. **バックグラウンド時の音声一時停止** ✅
   - `AppState`リスナーを使用してバックグラウンド遷移を検知
   - 再生中の音声を自動的に一時停止

#### 技術的詳細
- **依存関係の追加**: `AppState`, `AppStateStatus`, `usePlaybackActions`, `useAudioPinStore`
- **メモリリーク対策**: 非同期処理のエラーハンドリングとクリーンアップ
- **状態管理の統合**: TrackPlayerとZustandストアの双方向同期

### Phase 1 リファクタリング完了 (2025-07-25)

#### StateManagement.md準拠の実装
1. **AudioService（Infrastructure層）** ✅
   - TrackPlayerの操作を抽象化
   - シングルトンパターンで実装
   - エラーハンドリングの強化

2. **useAudioPlayerフック（Presentation層）** ✅
   - Infrastructure層とApplication層を統合
   - TrackPlayerイベントとZustandストアの同期
   - バックグラウンド処理の一元管理

3. **AudioPlayerModalの更新** ✅
   - TrackPlayerの直接操作を削除
   - useAudioPlayerフックを使用
   - レイヤー責務に従った実装

### Phase 1 追加修正 (2025-07-25)

#### 実機検証で発見された問題の修正
1. **モーダルスワイプ時の音声停止** ✅
   - 問題: スワイプでモーダルを閉じても音声が停止しない
   - 修正: `performTransition`で`CLOSED`時に`closeModal()`を呼ぶように変更

2. **バックグラウンドからの再生位置保持** ✅
   - 問題: バックグラウンドから復帰時に最初から再生される
   - 修正: AudioServiceに`currentTrackId`を追加し、同じトラックの場合はリセットしない

3. **ログアウト時のエラー対策** ✅
   - 問題: TrackPlayer未初期化時のエラー
   - 修正: 各メソッドに初期化チェックを追加

## 6. 実装優先順位とロードマップ

### フェーズ1（即座の修正 - 完了）
1. ✅ AudioPlayerModalのクリーンアップ処理追加
2. ✅ closeModal関数での音声停止実装
3. ✅ バックグラウンド時の音声一時停止

### Phase 2 実装完了 (2025-07-25)

#### レイヤー切替時のピン消失問題の解決
1. **クライアントサイドフィルタリング方式の採用** ✅
   - 問題: queryKeyにlayerIdsが含まれているため、レイヤー変更時に新しいクエリとして扱われる
   - 解決: 全ピンを取得し、クライアント側でフィルタリング

#### 実装内容
1. **useAudioPinsQueryの修正** ✅
   - queryKeyからlayerIdsを削除
   - 常に全てのピンを取得するように変更
   - キャッシュが効率的に活用される

2. **useFilteredAudioPinsフックの作成** ✅
   - クライアントサイドでレイヤーフィルタリングを実装
   - useMemoを使用して効率的にフィルタリング
   - デバッグログの追加

3. **既存フックの更新** ✅
   - useAudioPinsをuseFilteredAudioPinsを使用するように変更
   - 既存のインターフェースを維持
   - 後方互換性を確保

#### 技術的詳細
- **パフォーマンス最適化**: useMemoによる再計算の最小化
- **即座の反映**: レイヤー切替が遅延なく反映
- **APIリクエスト削減**: レイヤー変更時の不要なリクエストを排除

### フェーズ2（中期改善 - 完了）
1. ✅ AudioServiceシングルトンの実装（Phase 1で完了）
2. ✅ Zustandストアへの音声状態統合（Phase 1で完了）
3. ✅ レイヤー切替時のピン表示最適化（Phase 2で完了）

### フェーズ3（長期改善 - 1ヶ月）
1. 完全なリソース管理システムの実装
2. エラーバウンダリの追加
3. パフォーマンス最適化とテスト

## Phase 3 実装検討結果 (2025-07-25)

### 実装要否の検討

Phase 3で懸念されていたリソース管理の問題について、現在の実装状況を精査した結果、**追加実装は不要**と判断しました。

#### 既に解決済みの問題

1. **複数ピンの高速タップで音声が重複再生** ✅
   - `AudioService`の`currentTrackId`により、同じトラックの重複再生を防止
   - 異なるトラックの場合は`reset()`により前の音声を確実に停止
   - 実機テストでも問題なし

2. **メモリリークの可能性** ✅
   - Phase 1で適切なクリーンアップ処理を実装済み
   - コンポーネントアンマウント時の処理も完備
   - エラーハンドリングも充実

3. **状態管理の不整合** ✅
   - Phase 1のリファクタリングで解決済み
   - TrackPlayerとZustandストアの同期が確立

#### 未実装だが問題になっていない項目

1. **ネットワークリクエストのキャンセル処理**
   - React Queryの`signal`パラメータは未使用
   - しかし、実機テストで頻繁な地図操作でも問題なし
   - React Queryの内部キャッシュで十分機能している

### 決定事項

**現状維持を選択**

理由：
- 実機テストで高速操作や頻繁な操作でも安定動作を確認
- 追加実装によるコードの複雑化リスクが、得られるメリットを上回る
- 将来的に問題が発生した場合に、その時点で対応する方が効率的

### 今後のモニタリング項目

以下の問題が発生した場合は、Phase 3の実装を再検討：
- パフォーマンスの著しい低下
- ネットワークリクエストの過多によるエラー
- ユーザーからの具体的な不具合報告

## 7. テスト戦略

### ユニットテスト
- AudioServiceの各メソッドのテスト
- Zustandストアのアクションテスト
- クリーンアップ処理の検証

### 統合テスト
- モーダルの開閉と音声再生の連携
- レイヤー切替時の動作
- 複数ピンの連続選択

### E2Eテスト
- ユーザーシナリオベースのテスト
- メモリリークの検証
- パフォーマンステスト

## まとめ
AudioPin機能の問題は、主にリソース管理と状態管理の不備に起因しています。提案した解決策を段階的に実装することで、安定性とユーザー体験を大幅に改善できます。特に音声のメモリリークは緊急性が高いため、フェーズ1の実装を最優先で進めることを推奨します。